<!doctype html>
<html lang="en">
  <head>
    <title>AR Joystick Controlled Car with Plane Detection</title>
    <meta charset="utf-8">
    <meta name="description" content="AR joystick-controlled car with plane detection">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@master/examples/js/ar-hit-test.js"></script>
    <style>
      #joystick {
        position: absolute;
        bottom: 20px;
        left: 20px;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background-color: rgba(255, 165, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2;
      }

      #joystick:active {
        background-color: rgba(255, 165, 0, 1);
      }
    </style>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <!-- A-Frame Scene -->
    <a-scene embedded arjs>
      <!-- Hit Test Source for Plane Detection -->
      <a-entity id="hit-test" 
                raycaster="objects: .clickable" 
                cursor="fuse: false; rayOrigin: mouse"
                webxr-hit-test 
                position="0 0 0">
      </a-entity>
      
      <!-- Placeholder for detected plane -->
      <a-entity id="placement-indicator" 
                visible="false" 
                geometry="primitive: ring; radiusOuter: 0.1; radiusInner: 0.08;" 
                material="color: green; shader: flat" 
                position="0 0 0" 
                rotation="-90 0 0">
      </a-entity>
      
      <!-- 3D Car Model -->
      <a-entity id="car" 
                gltf-model="./car.glb" 
                visible="false" 
                position="0 0 0" 
                scale="0.5 0.5 0.5" 
                class="clickable">
      </a-entity>
      
      <!-- Lighting -->
      <a-light type="ambient" intensity="0.5"></a-light>
      <a-light type="directional" position="0 5 -5" intensity="1"></a-light>
    </a-scene>

    <!-- Joystick -->
    <div id="joystick">â¬¤</div>

    <script>
      const scene = document.querySelector('a-scene');
      const car = document.querySelector('#car');
      const hitTestEntity = document.querySelector('#hit-test');
      const placementIndicator = document.querySelector('#placement-indicator');
      let carPlaced = false;

      // Enable hit test functionality when AR session starts
      scene.addEventListener('enter-vr', () => {
        const xrSession = scene.renderer.xr.getSession();

        xrSession.requestReferenceSpace('local-floor').then((referenceSpace) => {
          xrSession.requestHitTestSource({ space: referenceSpace }).then((hitTestSource) => {
            scene.addEventListener('updateFrame', () => {
              const frame = scene.renderer.xr.getFrame();

              // Perform hit test
              const hitTestResults = frame.getHitTestResults(hitTestSource);
              if (hitTestResults.length > 0) {
                const hit = hitTestResults[0];
                const pose = hit.getPose(referenceSpace);

                placementIndicator.setAttribute('visible', true);
                placementIndicator.object3D.position.set(pose.transform.position.x, pose.transform.position.y, pose.transform.position.z);

                if (!carPlaced && car.getAttribute('visible') === false) {
                  car.object3D.position.set(pose.transform.position.x, pose.transform.position.y, pose.transform.position.z);
                  car.setAttribute('visible', true);
                }
              } else {
                placementIndicator.setAttribute('visible', false);
              }
            });
          });
        });
      });

      // Joystick Control Logic
      const joystick = document.getElementById('joystick');
      let carPosition = { x: 0, y: 0, z: 0 };

      joystick.addEventListener('touchmove', (event) => {
        const touch = event.touches[0];
        const deltaX = touch.clientX - window.innerWidth / 2;
        const deltaY = touch.clientY - window.innerHeight / 2;

        // Update car position based on joystick movement
        carPosition.x += deltaX * 0.001;
        carPosition.z += deltaY * 0.001;

        car.object3D.position.set(carPosition.x, carPosition.y, carPosition.z);
      });

      // Collision Detection Example
      const checkCollision = () => {
        if (carPosition.x > 5 || carPosition.x < -5 || carPosition.z > 5 || carPosition.z < -5) {
          console.log('Collision detected!');
        }
      };

      setInterval(checkCollision, 100); // Check for collision every 100ms
    </script>
  </body>
</html>
